SELECT 
CONVERT(VARCHAR, O.DATE_ADD, 101) AS DATE_ADD, 
O.ID_VND_PAYTO AS [CARRIER],
LEFT(TRIM(O.REF),6) AS [PO],
O.REF AS [SHIPMENT REF],
O.ID_INVC_VND AS [PRO/INV], 
P.ID_INVC_VND AS [VENDOR INV#],
CONVERT(VARCHAR,P.DATE_INVC,101) AS [VND INV/SHIP DATE], 
P.ID_PO AS [PO#],
P.ID_ITEM AS [ITEM #],
A.AMT_DISTRIB AS [FREIGHT$],
(P.QTY_PAID) AS [QTY],
P.AMT_DISTRIB AS [TOTAL COST],
STR(ROUND(P.AMT_DISTRIB/P.QTY_PAID,2),10,4) AS [UNIT PRICE],
ISNULL(B.RATIO_STK_PUR,'1') AS [S/P RATIO],
STR(ROUND(A.AMT_DISTRIB/P.QTY_PAID,2),10,4) AS [FREIGHT S/P],
STR(ROUND((P.AMT_DISTRIB/P.QTY_PAID)/B.RATIO_STK_PUR,2),10,4) AS [MATERIAL COST],
STR(ROUND((A.AMT_DISTRIB/P.QTY_PAID)/B.RATIO_STK_PUR,2),10,4) AS [OUTSIDE COST],
STR(ROUND(((P.AMT_DISTRIB/P.QTY_PAID)/B.RATIO_STK_PUR)+((A.AMT_DISTRIB/P.QTY_PAID)/B.RATIO_STK_PUR),2),10,4) AS TOTAL_STD_COST,
P.ID_VOUCH,
O.ID_VOUCH, 
A.ID_VOUCH,
A.ACCT_ID,
A.ACCT_DIV, 
A.ACCT_LOC,
A.ACCT_DEPT
FROM POHIST_LINE_INVC P 
JOIN APOPEN O ON CONVERT(VARCHAR,P.ID_PO) =LEFT(TRIM(O.REF),6)
JOIN APDIST A ON A.ID_VOUCH=O.ID_VOUCH
JOIN ITMMAS_BASE B ON B.ID_ITEM=P.ID_ITEM
WHERE (O.DATE_ADD BETWEEN'2021-01-01' AND '2021-03-31')  AND A.ACCT_ID = '5046' AND O.REF NOT LIKE '%P/O%' AND B.ID_ITEM IS NOT NULL AND (P.DATE_INVC < O.DATE_ADD)
ORDER BY P.DATE_ADD DESC