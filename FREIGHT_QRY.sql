SELECT 
'2021' AS [FISCAL_YEAR],
MONTH(P.DATE_INVC) AS [MONTH],
YEAR(P.DATE_INVC) AS [YEAR],
CONVERT(VARCHAR, O.DATE_ADD, 101) AS [SHIPMENT_INVC_DATE], 
O.ID_VND_PAYTO AS [CARRIER],
LEFT(TRIM(O.REF),6) AS [PO],
O.REF AS [SHIPMENT_REF],
O.ID_INVC_VND AS [PRO_INV], 
O.ID_VOUCH AS [SHIPMENT_VOUCHER_ID], 
P.ID_VND_PAYTO AS [VENDOR],
P.ID_INVC_VND AS [VENDOR_INV],
P.ID_VOUCH AS [PO_VOUCHER_ID],
CONVERT(VARCHAR,P.DATE_INVC,101) AS [PO_INVC_DATE], 
P.ID_PO AS [PO],
P.ID_ITEM AS [ITEM_ID],
A.AMT_DISTRIB AS [FREIGHT_TOTAL],
PT.ID_PO AS [PO_ID], 
SUM(PT.QTY_PAID) AS [TOTAL_QTY_PAID],
(P.QTY_PAID) AS [QTY],
STR(ROUND(P.AMT_DISTRIB/P.QTY_PAID,2),10,4) AS [UNIT_PRICE],
ISNULL(B.RATIO_STK_PUR,'1') AS [STK_PUR_RATIO],
STR(ROUND(A.AMT_DISTRIB/PT.QTY_PAID,2),10,4) AS [FREIGHT_STK_PUR],
STR(ROUND((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR,2),10,4) AS [MATERIAL_COST],
STR(ROUND((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR,2),10,4) AS [OUTSIDE_COST],
STR(ROUND(((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)+((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR),2),10,4) AS [TOTAL_STD_COST],
C.COST_MATL_VA_STD AS [TCM_MTL],
C.COST_OUTP_VA_STD AS [TCM_OUT],
COST_TOTAL_ACCUM_STD AS [TCM_TOTAL],
STR(ROUND((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR,2),10,4)-C.COST_OUTP_VA_STD AS [FRT_VS_OUTSIDE_COST],
A.ACCT_ID,
A.ACCT_DIV, 
A.ACCT_LOC,
A.ACCT_DEPT
FROM POHIST_LINE_INVC P 
INNER JOIN POHIST_LINE_INVC PT ON PT.ID_INVC_VND = P.ID_INVC_VND
INNER JOIN APOPEN O ON CONVERT(VARCHAR,PT.ID_PO) LIKE LEFT(TRIM(O.REF),6)
INNER JOIN APDIST A ON A.ID_VOUCH=O.ID_VOUCH
INNER JOIN ITMMAS_BASE B ON B.ID_ITEM=P.ID_ITEM
INNER JOIN ITMMAS_COST C ON C.ID_ITEM=P.ID_ITEM
WHERE (P.DATE_INVC BETWEEN'2020-10-01' AND '2021-09-30')  AND A.ACCT_ID = '5046' AND O.REF NOT LIKE '%P/O%' AND B.ID_ITEM IS NOT NULL AND (P.DATE_INVC < O.DATE_ADD) AND (P.ID_ITEM NOT LIKE '%CHARGE%' AND P.ID_ITEM NOT LIKE '%ZP%' AND P.ID_ITEM NOT LIKE '%ZN%')
GROUP BY 
PT.ID_PO,
PT.ID_VOUCH,
PT.ID_INVC_VND,
P.ID_PO, 
P.ID_ITEM,
P.ID_VND_PAYTO, 
P.DATE_ADD,
P.ID_VOUCH,
P.DATE_VOUCH,
P.ID_INVC_VND,
P.DATE_INVC,
P.QTY_PAID,
P.AMT_DISTRIB,
P.AMT_DISTRIB/P.QTY_PAID,
O.DATE_ADD, 
O.ID_VND_PAYTO ,
A.VENDOR_NAME ,
O.REF,
O.ID_INVC_VND,
P.ID_VND_PAYTO,
P.ID_INVC_VND ,
A.AMT_DISTRIB ,
(P.QTY_PAID),
P.AMT_DISTRIB,
P.AMT_DISTRIB/P.QTY_PAID,
B.RATIO_STK_PUR,
C.COST_MATL_VA_STD,
C.COST_OUTP_VA_STD,
COST_TOTAL_ACCUM_STD,
((A.AMT_DISTRIB/P.QTY_PAID)/B.RATIO_STK_PUR)-C.COST_OUTP_VA_STD ,
P.ID_VOUCH,
O.ID_VOUCH, 
A.ID_VOUCH,
A.ACCT_ID,
A.ACCT_DIV, 
A.ACCT_LOC,
A.ACCT_DEPT,
((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)-C.COST_OUTP_VA_STD ,
A.AMT_DISTRIB/PT.QTY_PAID,
((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR),
((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR),
((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)+((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)
ORDER BY P.DATE_INVC DESC, P.ID_PO, P.ID_ITEM

SELECT 
'2020' AS [FISCAL_YEAR],
MONTH(P.DATE_INVC) AS [MONTH],
YEAR(P.DATE_INVC) AS [YEAR],
CONVERT(VARCHAR, O.DATE_ADD, 101) AS [SHIPMENT_INVC_DATE], 
O.ID_VND_PAYTO AS [CARRIER],
LEFT(TRIM(O.REF),6) AS [PO],
O.REF AS [SHIPMENT_REF],
O.ID_INVC_VND AS [PRO_INV], 
O.ID_VOUCH AS [SHIPMENT_VOUCHER_ID], 
P.ID_VND_PAYTO AS [VENDOR],
P.ID_INVC_VND AS [VENDOR_INV],
P.ID_VOUCH AS [PO_VOUCHER_ID],
CONVERT(VARCHAR,P.DATE_INVC,101) AS [PO_INVC_DATE], 
P.ID_PO AS [PO],
P.ID_ITEM AS [ITEM_ID],
A.AMT_DISTRIB AS [FREIGHT_TOTAL],
PT.ID_PO AS [PO_ID], 
SUM(PT.QTY_PAID) AS [TOTAL_QTY_PAID],
(P.QTY_PAID) AS [QTY],
STR(ROUND(P.AMT_DISTRIB/P.QTY_PAID,2),10,4) AS [UNIT_PRICE],
ISNULL(B.RATIO_STK_PUR,'1') AS [STK_PUR_RATIO],
STR(ROUND(A.AMT_DISTRIB/PT.QTY_PAID,2),10,4) AS [FREIGHT_STK_PUR],
STR(ROUND((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR,2),10,4) AS [MATERIAL_COST],
STR(ROUND((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR,2),10,4) AS [OUTSIDE_COST],
STR(ROUND(((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)+((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR),2),10,4) AS [TOTAL_STD_COST],
C.COST_MATL_VA_STD AS [TCM_MTL],
C.COST_OUTP_VA_STD AS [TCM_OUT],
COST_TOTAL_ACCUM_STD AS [TCM_TOTAL],
STR(ROUND((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR,2),10,4)-C.COST_OUTP_VA_STD AS [FRT_VS_OUTSIDE_COST],
A.ACCT_ID,
A.ACCT_DIV, 
A.ACCT_LOC,
A.ACCT_DEPT
FROM POHIST_LINE_INVC P 
LEFT JOIN POHIST_LINE_INVC PT ON PT.ID_INVC_VND = P.ID_INVC_VND
JOIN APOPEN O ON CONVERT(VARCHAR,PT.ID_PO) =LEFT(TRIM(O.REF),6)
JOIN APDIST A ON A.ID_VOUCH=O.ID_VOUCH
JOIN ITMMAS_BASE B ON B.ID_ITEM=P.ID_ITEM
JOIN ITMMAS_COST C ON C.ID_ITEM=P.ID_ITEM
WHERE (P.DATE_INVC BETWEEN'2019-10-01' AND '2020-09-30')  AND A.ACCT_ID = '5046' AND O.REF NOT LIKE '%P/O%' AND B.ID_ITEM IS NOT NULL AND (P.DATE_INVC < O.DATE_ADD) AND (P.ID_ITEM NOT LIKE '%CHARGE%' AND P.ID_ITEM NOT LIKE '%ZP%' AND P.ID_ITEM NOT LIKE '%ZN%') AND P.QTY_PAID > '0'
GROUP BY 
PT.ID_PO,
PT.ID_VOUCH,
PT.ID_INVC_VND,
P.ID_PO, 
P.ID_ITEM,
P.ID_VND_PAYTO, 
P.DATE_ADD,
P.ID_VOUCH,
P.DATE_VOUCH,
P.ID_INVC_VND,
P.DATE_INVC,
P.QTY_PAID,
P.AMT_DISTRIB,
P.AMT_DISTRIB/P.QTY_PAID,
O.DATE_ADD, 
O.ID_VND_PAYTO ,
P.ID_VND_PAYTO,
A.VENDOR_NAME ,
O.REF,
O.ID_INVC_VND,
P.ID_INVC_VND ,
A.AMT_DISTRIB ,
(P.QTY_PAID),
P.AMT_DISTRIB,
P.AMT_DISTRIB/P.QTY_PAID,
B.RATIO_STK_PUR,
C.COST_MATL_VA_STD,
C.COST_OUTP_VA_STD,
COST_TOTAL_ACCUM_STD,
((A.AMT_DISTRIB/P.QTY_PAID)/B.RATIO_STK_PUR)-C.COST_OUTP_VA_STD ,
P.ID_VOUCH,
O.ID_VOUCH, 
A.ID_VOUCH,
A.ACCT_ID,
A.ACCT_DIV, 
A.ACCT_LOC,
A.ACCT_DEPT,
((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)-C.COST_OUTP_VA_STD ,
A.AMT_DISTRIB/PT.QTY_PAID,
((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR),
((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR),
((P.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)+((A.AMT_DISTRIB/PT.QTY_PAID)/B.RATIO_STK_PUR)
ORDER BY P.DATE_INVC DESC, P.ID_PO, P.ID_ITEM